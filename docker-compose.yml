# Flask Auth Skeleton - Docker Compose Configuration
# Requirements: 8.2 - THE System SHALL include a docker-compose.yml that orchestrates the application services
# Requirements: 8.5 - THE System SHALL persist SQLite data using Docker volumes

services:
  # Flask Application Service
  flask-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: flask-auth-skeleton
    
    # Port mapping: host:container
    ports:
      - "${FLASK_PORT:-5000}:5000"
    
    # Volume mounts for development and data persistence
    volumes:
      # Mount application code for development (hot reload)
      - .:/app
      # Named volume for SQLite data persistence (Requirement 8.5)
      - sqlite-data:/data
      # Exclude node_modules and other build artifacts
      - /app/__pycache__
      - /app/.pytest_cache
    
    # Environment variable configuration (Requirement 8.4)
    environment:
      # Flask configuration
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - FLASK_ENV=${FLASK_ENV:-development}
      - FLASK_DEBUG=${FLASK_DEBUG:-1}
      
      # Database configuration - use Docker volume path
      - DATABASE_URL=sqlite:////data/app.db
      
      # OAuth provider credentials
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - FACEBOOK_CLIENT_ID=${FACEBOOK_CLIENT_ID:-}
      - FACEBOOK_CLIENT_SECRET=${FACEBOOK_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      
      # Application settings
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=5000
      
      # Admin user seeding (optional)
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-changeme123}
    
    # Use .env file for environment variables (if it exists)
    # Copy .env.example to .env and configure your values
    env_file:
      - path: .env
        required: false
    
    # Restart policy
    restart: unless-stopped
    
    # Health check to ensure the application is running
    # Uses Python to make HTTP request since curl may not be in slim image
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Named volumes for data persistence
volumes:
  # SQLite data volume (Requirement 8.5)
  # This ensures database data persists across container restarts
  sqlite-data:
    driver: local
